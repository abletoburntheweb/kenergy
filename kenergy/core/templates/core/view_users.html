<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Просмотр пользователей</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/view_users.css' %}">
    <!-- Подключаем jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js "></script>
</head>
<body>
    <div class="form-container">
        <h2>Список пользователей</h2>

        <form method="get" class="search-form">
            <input type="text" name="q" placeholder="Поиск по логину..." class="search-input">
            <button type="submit" class="search-btn">Найти</button>
        </form>

        {% if users %}
            <table border="1">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Логин</th>
                        <th>Администратор</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.is_staff|yesno:"Да,Нет" }}</td>
                            <td>
                                <!-- Кнопка "Удалить" -->
                                <a href="#" class="delete-user-btn" data-user-id="{{ user.id }}">Удалить</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: red; font-weight: bold;">Пользователей не найдено.</p>
        {% endif %}

        <br>
        <a href="{% url 'edit_db' %}" class="btn-back">Назад</a>
    </div>

    <!-- Скрипт для обработки удаления пользователя -->
    <script>
        $(document).ready(function () {
            $('.delete-user-btn').click(function (e) {
                e.preventDefault(); // Предотвращаем переход по ссылке

                var userId = $(this).data('user-id'); // Получаем ID пользователя
                var csrfToken = '{{ csrf_token }}'; // Получаем CSRF-токен

                // Отправляем POST-запрос на удаление пользователя
                $.ajax({
                    url: '{% url 'delete_user' %}', // URL для удаления пользователя
                    type: 'POST',
                    data: {
                        user_id: userId,
                        csrfmiddlewaretoken: csrfToken,
                    },
                    success: function (response) {
                        if (response.success) {
                            // Успешное удаление: обновляем страницу или удаляем строку из таблицы
                            location.reload();
                        } else {
                            alert('Ошибка при удалении пользователя.');
                        }
                    },
                    error: function () {
                        alert('Произошла ошибка при удалении пользователя.');
                    }
                });
            });
        });
    </script>
</body>
</html>